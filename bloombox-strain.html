
<!--
`<bloombox-strain>` provides a form for creating, editing and viewing cannabis flower strains.

@group Bloombox Elements
@element bloombox-strain
@demo demo/index.html
@homepage bloombox.github.io
-->

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-label/iron-label.html">

<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../bloombox-media/bloombox-media.html">
<link rel="import" href="../bloombox-styles/bloombox-styles.html">
<link rel="import" href="../bloombox-testing/bloombox-testing.html">
<link rel="import" href="../bloombox-product/bloombox-product.html">
<link rel="import" href="../bloombox-pricelist/bloombox-pricelist.html">


<dom-module id="bloombox-strain">
  <template>
    <style is="custom-style" include="bloombox-styles">
      :host {
        display: block;
        width: 100%;
      }
    </style>

    <!-- - - - - - - - - - - -->
    <!--   Sealed  Content   -->
    <!-- - - - - - - - - - - -->
    <template is="dom-if" if="[[!zerostate]]">
      <paper-card heading="[[name]]" class="product-card flower-product data-content fullwidth">
        <div class="card-content">
          <!-- Description -->
          <div class="row description-container">
            <template is="dom-if" if="[[!_slim]]">
              <template is="dom-if" if="[[description]]">
                <div class="product-description">[[description]]</div>
              </template>
              <template is="dom-if" if="[[!description]]">
                <div class="no-description">(No description)</div>
              </template>
            </template>
          </div><!-- end div.row.description-container -->

          <!-- Stock Flags -->
          <div class="stock-flags strain-info test-info row">
            <!-- MPMH -->
            <iron-label class="premium-label" hidden$="[[!premium]]"><span>[[_renderPremiumLabel(partner)]]</span></iron-label>

            <!-- Sale -->
            <iron-label class="sale-label" hidden$="[[!sale]]"><span>[[sale]]% OFF</span></iron-label>

            <!-- Buy-One-Get-One -->
            <iron-label class="bogo-label" hidden$="[[!bogo]]"><span>Buy One Get One</span></iron-label>

            <!-- Grow -->
            <iron-label class="grow-label"><span>[[grow]]</span></iron-label>

            <!-- Species -->
            <iron-label class="species-label"><span>[[species]]</span></iron-label>

            <!-- Test Results -->
            <bloombox-testing
              mode="rich"
              thc="[[tests.thc]]"
              cbd="[[tests.cbd]]"
              pinene="[[tests.terpenes.pinene]]"
              myrcene="[[tests.terpenes.myrcene]]"
              limonene="[[tests.terpenes.limonene]]"
              linalool="[[tests.terpenes.linalool]]"
              caryophyllene="[[tests.terpenes.caryophyllene]]"></bloombox-testing>
          </div><!-- end div.row.stock-flags -->

          <!-- Product Media -->
          <div class="product-media flower-media row">
            <div class="bloombox-media-wrap">
              <bloombox-media
                disabled
                hidden$="[[_shouldHideImage()]]"
                partner="[[partner]]"
                environment="[[environment]]"
                asset="[[_image]]"></bloombox-media>
            </div><!-- end div.bloombox-media-wrap -->
          </div><!-- end .row.test-results -->

          <!-- Price List -->
          <div class="row pricelist">
            <bloombox-pricelist
              class="strainSealedPricelist"
              manifest="[[pricing]]"
              currency="$"></bloombox-pricelist>
          </div><!-- end div.row.pricelist -->
          <template is="dom-if" if="[[!visible]]">
            <div class="not-in-stock-overlay not-in-stock"></div><!-- end div.not-in-stock-overlay.not-in-stock -->
          </template>
        </div><!-- end div.strain-data-content.card-content -->
        <div class="card-actions">
          <paper-button on-tap="edit"><iron-icon icon="create"></iron-icon>Edit</paper-button>
          <paper-button on-tap="delete"><iron-icon icon="delete"></iron-icon>Delete</paper-button>
        </div><!-- end div.card-actions -->
      </paper-card><!-- end paper-card.product-card.flower-product -->
    </template>
    
    <!-- - - - - - - - - - - -->
    <!-- Zero-State  Content -->
    <!-- - - - - - - - - - - -->
    <template is="dom-if" if="[[zerostate]]">
      <paper-card heading="Flower" class="product-card zerostate fullwidth flower-product">
        <div class="card-content">
          <div class="basic-info row">
            <!-- Strain Name & Description -->
            <paper-input id="nameField" placeholder="Strain Name" value="[[name]]" required no-label-float name="name" class="form-item strain-name"></paper-input>
            <paper-textarea id="descriptionField" label="Description" value="[[description]]" no-label-float name="description" class="form-item strain-description"></paper-textarea>
          </div><!-- end .row.basic-info -->

          <div class="category-info row">
            <div class="row-label">
              <span class="row-label-value">Origins</span>
            </div><!-- end div.row-label -->

            <div class="ancestry-genetics">
              <paper-checkbox id="ancestryToggle" on-tap="_toggleAncestry" checked="[[_knownAncestry()]]" class="ancestry-toggle" class="form-item" noink name="ancestryKnown">Known Ancestry</paper-checkbox>

              <div class="ancestry-spec">
                <template is="dom-if" if="{{ancestry}}">
                  <paper-input id="maleAncestryField" no-label-float value="[[ancestry.male]]" class="form-item" label="Male" name="maleAncestry"></paper-input>
                  <span class="genetics-separator">x</span>
                  <paper-input id="femaleAncestryField" no-label-float value="[[ancestry.female]]" class="form-item" label="Female" name="femaleAncestry"></paper-input>
                </template>
              </div><!-- end div.ancestry-spec -->
            </div><!-- end .row.ancestry-genetics -->

            <!-- Grow -->
            <paper-dropdown-menu id="growField" label="Grow" class="form-item" noink no-label-float required name="grow">
              <paper-listbox class="dropdown-content" selected="{{grow}}">
                <paper-item>Indoor</paper-item>
                <paper-item>Greenhouse</paper-item>
                <paper-item>Outdoor</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>

            <!-- Species -->
            <paper-dropdown-menu id="speciesField" label="Species" class="form-item" noink no-label-float required name="species">
              <paper-listbox class="dropdown-content" selected="{{species}}">
                <paper-item>Indica</paper-item>
                <paper-item>Hybrid (Indica Dominant)</paper-item>
                <paper-item>Hybrid (No Dominance)</paper-item>
                <paper-item>Hybrid (Sativa Dominant)</paper-item>
                <paper-item>Sativa</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div><!-- end .row.category-info -->

          <!-- Pricing/Sale Flags -->
          <div class="stock-flags row">
            <div class="row-label">
              <span class="row-label-value">Inventory</span>
            </div><!-- end div.row-label -->

            <div class="in-stock-toggle-option">
              <paper-checkbox id="showToggle" checked="{{visible}}" class="form-item show-item-toggle" noink>In Stock</paper-checkbox>
            </div><!-- end .in-stock-toggle-option -->

            <div class="premium-toggle-option">
              <paper-checkbox id="premiumToggle" checked="{{premium}}" class="form-item premium-toggle" noink>[[_renderPremiumLabel(partner)]]</paper-checkbox>
            </div><!-- end .premium-toggle-option -->

            <div class="sale-toggle-option">
              <div class="sale-toggle-container">
                <paper-checkbox id="saleToggle" checked="[[_isOnSale()]]" on-tap="toggleSale" class="form-item sale-toggle" noink>On Sale</paper-checkbox>
              </div><!-- end .sale-toggle-container -->
              <template is="dom-if" if="{{sale}}">
                <div class="sale-amount-container">
                  <paper-slider id="saleValue" pin value="{{sale}}" max="95" min="5" editable step="5" class="form-item"></paper-slider>
                </div><!-- end .sale-amount-container -->
                <div class="sale-percentage-label">% off</div>
              </template>
            </div><!-- end .sale-toggle-option -->

            <div class="bogo-toggle-option">
              <paper-checkbox id="bogoToggle" checked="{{bogo}}" class="form-item item-bogo-toggle" noink>Buy One, Get One</paper-checkbox>
            </div><!-- end .bogo-toggle-option -->
          </div><!-- end .row.stock-flags -->
          
          <!-- Test Results -->
          <div class="test-results row">
            <div class="row-label">
              <span class="row-label-value">Testing</span>
            </div><!-- end div.row-label -->

            <paper-checkbox id="testsToggle" checked="[[_hasKnownTestResults()]]" on-tap="_toggleTests" class="form-item tests-toggle" noink>Test Results</paper-checkbox>
            <div class="test-results-container">
              <template is="dom-if" if="{{tests}}">
                <bloombox-testing
                  id="productTesting"
                  zerostate
                  mode="rich"
                  thc="{{tests.thc}}"
                  cbd="{{tests.cbd}}"
                  pinene="{{tests.terpenes.pinene}}"
                  myrcene="{{tests.terpenes.myrcene}}"
                  limonene="{{tests.terpenes.limonene}}"
                  linalool="{{tests.terpenes.linalool}}"
                  caryophyllene="{{tests.terpenes.caryophyllene}}"></bloombox-testing>
              </template>
            </div><!-- end .test-results-container -->
          </div><!-- end .row.test-results -->

          <!-- Product Media -->
          <div class="flower-media row">
            <div class="bloombox-media-wrap">
              <bloombox-media
                partner="[[partner]]"
                environment="[[environment]]"
                asset="[[_image]]"
                on-asset-ready="handleAssetAttach"></bloombox-media>
            </div><!-- end div.bloombox-media-wrap -->
          </div><!-- end .row.flower-media -->

          <!-- Price List -->
          <div class="row pricelist">
            <bloombox-pricelist
              class="editablePricelist"
              manifest='{{pricing}}'
              currency="$"
              editable></bloombox-pricelist>
          </div><!-- end .row.pricelist -->
        </div>
        <!-- Actions -->
        <template is="dom-if" if="[[editing]]">
          <div class="strain-zerostate-actions card-actions row">
            <paper-button
              id="saveButton"
              raised
              on-tap="commitEdits">
              <iron-icon icon="save"></iron-icon>Save</paper-button>
            <paper-button
              id="cancelButton"
              on-tap="cancelEdits"><iron-icon icon="cancel"></iron-icon>Cancel</paper-button>
          </div><!-- end .strain-zerostate-actions.card-actions -->
        </template>
        <template is="dom-if" if="[[!editing]]">
          <div class="strain-zerostate-actions edit-actions card-actions row">
            <paper-button
              id="submitButton"
              raised
              on-tap="persist"><iron-icon icon="check-circle"></iron-icon>Create</paper-button>
            <paper-button
              id="discardButton"
              on-tap="_triggerDiscard"><iron-icon icon="cancel"></iron-icon>Discard</paper-button>
          </div><!-- end .strain-zerostate-actions.card-actions.edit-actions -->
        </template>
      </paper-card><!-- end paper-card.flower-product -->
    </template>
  </template>

  <script>
    Polymer.BloomboxStrain = Polymer({
      is: 'bloombox-strain',
      behaviors: [Polymer.BloomboxBaseProductCardBehavior],

      /**
       * Persistence schema and storage collection for this item.
       */
      _schema: 'flowers',

      properties: {
        /**
         * Stores ancestry for this flower item, if known. Ancestry is defined as
         * the parent male + female plant, and is structured as an `Object` with two
         * properties: `male` and `female`. Each is a `String` name of a strain.
         */
        ancestry: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Pricing for flowers is rather extensive and based on different standard weights:
         * - `gram`
         * - `eighth`
         * - `quarter`
         * - `half`
         * - `ounce`
         */
        pricing: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() {
            return [{"label": "gram", "available": true, "price": 0}, {"label": "eighth", "available": true, "price": 0}, {"label": "quarter", "available": true, "price": 0}, {"label": "half", "available": true, "price": 0}, {"label": "ounce", "available": true, "price": 0}];
          }
        }
      },

      /**
       * Render function to determine whether ancestry is known.
       */
      _knownAncestry: function() {
        return this.ancestry !== undefined && this.ancestry !== null && typeof this.ancestry == "object";
      },

      /**
       * Responder function to toggle ancestry management UI.
       */
      _toggleAncestry: function() {
        this.ancestry = this.$$("#ancestryToggle").checked ?
          {} : undefined;
      },

      /**
       * Read underlying object data, suitable for writing into underlying persistence
       * or comparing with edits.
       */
      readObjectData: function() {
        var payload = {};

        // handle required fields
        payload.name = this.get("name");
        payload.grow = this.get("grow");
        payload.species = this.get("species");
        payload.pictures = this.get("photos") || [];
        payload.pricelist = this.get("pricing");

        // handle ancestry
        if (this.get("ancestry") !== undefined && this.get("ancestry") != null) {
          payload.ancestry = {
            male: this.get("ancestry").male,
            female: this.get("ancestry").female
          };
        }

        // handle test results
        if (this.get("tests") !== undefined && this.get("tests") != null) {
          payload.tests = {
            thc: this.get("tests").thc,
            cbd: this.get("tests").cbd,
            terpenes: {
              pinene: this.get("tests").terpenes.pinene,
              myrcene: this.get("tests").terpenes.myrcene,
              limonene: this.get("tests").limonene,
              caryophyllene: this.get("tests").caryophyllene,
              linalool: this.get("tests").linalool
            }
          };
        }

        // handle optional fields
        if (this.get("premium") == true) {
          payload.flags = payload.flags || {};
          payload.flags.premium = true;
        }
        if (this.get("sale") !== undefined && this.get("sale") != null) {
          payload.flags = payload.flags || {};
          payload.flags.sale = this.get("sale");
        }
        if (this.get("visible") != null && this.get("visible") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.visible = this.get("visible");
        }
        if (this.get("bogo") != null && this.get("bogo") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.bogo = this.get("bogo");
        }
        if (this.get("description") !== undefined && this.get("description") !== null &&
            this.get("description").length > 0) payload.description = this.get("description");
        return payload;
      },

      /**
       * Read underlying object data direct from the current zero-state form.
       */
      readZeroStateForm: function() {
        var payload = {},
            manifest = this.$$(".editablePricelist").readManifest(this),
            pricelist = {},
            mi, mpayload, testing;

        // handle required fields
        payload.name = this.$$("#nameField").value;
        payload.grow = this.$$("#growField").value;
        payload.species = this.$$("#speciesField").value;

        if (this.get("photos") && this.get("photos").length > 0)
          payload.pictures = this.get("photos");

        // handle ancestry
        if (this.$$("#ancestryToggle").checked) {
          payload.ancestry = {
            male: this.$$("#maleAncestryField").value,
            female: this.$$("#femaleAncestryField").value
          };
        }

        // handle test results
        if (this.$$("#testsToggle").checked) {
          testing = this.$$("#productTesting");
          payload.tests = {
            thc: testing.thc,
            cbd: testing.cbd,
            terpenes: {
              pinene: testing.pinene,
              myrcene: testing.myrcene,
              limonene: testing.limonene,
              caryophyllene: testing.caryophyllene,
              linalool: testing.linalool
            }
          };
        }

        // handle pricing
        for (mi in manifest) {
          mpayload = manifest[mi];
          pricelist[bloom.strings.strainLabels[mpayload["label"]]] = {
            available: mpayload["available"],
            price: Number(mpayload["price"])
          }
        }
        payload.pricelist = pricelist;

        // handle optional fields
        if (this.$$("#premiumToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.premium = true;
        }
        if (this.$$("#showToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.visible = true;
        } else {
          payload.flags = payload.flags || {};
          payload.flags.visible = false;
        }
        if (this.$$("#bogoToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.bogo = true;
        }
        if (this.$$("#saleToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.sale = this.$$("#saleValue").value;
        }
        if (this.$$("#descriptionField").value !== undefined && this.$$("#descriptionField").value.length > 0)
          payload.description = this.$$("#descriptionField").value;
        return payload;
      }
    });
  </script>
</dom-module>
